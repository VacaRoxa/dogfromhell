// new module script
#define APROXCHAR 60
int bonePileCount;
Timer * t_killMember;
Timer * t_enemy2[APROXCHAR];  //time throwing
Timer * t_enemy2_whenToStartThrow[APROXCHAR];  //this number is only big enough to not crash
bool enemy2_didthrow[APROXCHAR];  //time throwing

int destination_left;
int destination_right;

function game_start() 
{
  destination_left = 24 ;
  destination_right = 224 - 24;
}

void checkWinCondition(){
  if(bonePileCount >= 3){
    // damn you cute player, you won!
    
    Wait(SecondsToLoops(1.0));
    
    if(player.Room == 1){
      player.ChangeRoom(2, 21, 284, eDirectionRight);
    } else if(player.Room == 2){
      player.ChangeRoom(3, 21, 284, eDirectionRight);
    } else if(player.Room == 3){
      player.ChangeRoom(4, 21, 284, eDirectionRight);
    } else if(player.Room == 4){
      player.ChangeRoom(5, 21, 284, eDirectionRight);
    } 
  }
}

bool isDogWithBonne(){
  return cDog.View == DOGIDDLE2 || cDog.View == DOGWALK2 ; 
}

bool isCharEnemy1(Character * enemy){
  return enemy.ID == cEnemy1_0.ID ||   
         enemy.ID == cEnemy1_1.ID ||  
         enemy.ID == cEnemy1_2.ID ||   
         enemy.ID == cEnemy1_3.ID ||  
         enemy.ID == cEnemy1_4.ID ||  
         enemy.ID == cEnemy1_5.ID ;
}

bool isCharEnemy2(Character * enemy){
  return enemy.ID == cEnemy2_0.ID ||   
         enemy.ID == cEnemy2_1.ID ||  
         enemy.ID == cEnemy2_2.ID ||  
         enemy.ID == cEnemy2_3.ID ;
}


void dogGainsBone(){
  if(!isDogWithBonne()){
    cDog.ChangeView(DOGWALK2);
    cDog.SetIdleView(DOGIDDLE2, 1);
    KeyboardMovement.SetIdleView(DOGIDDLE2, 1);   
  }
}

void dogLooseBone(){
  if(isDogWithBonne()){
    cDog.ChangeView(DOGWALK1);
    cDog.SetIdleView(DOGIDDLE1, 1);
    KeyboardMovement.SetIdleView(DOGIDDLE1, 1);   
  }
}

void updateBonePileGraphic(){
  if(bonePileCount == 0){
    cBonePile.ChangeView(BONEPILE0);
  } else if(bonePileCount == 1){
    cBonePile.ChangeView(BONEPILE1);
  } else if(bonePileCount == 2){
    cBonePile.ChangeView(BONEPILE2);
  } else if(bonePileCount == 3){
    cBonePile.ChangeView(BONEPILE3);
  } 
}

void resetBonePile(){
  bonePileCount = 0;
  updateBonePileGraphic();
} 

int incrementBonePile(){
  bonePileCount++;
  updateBonePileGraphic();
  checkWinCondition();
}

void dogHitBonePile(){
  if(isDogWithBonne()){
    dogLooseBone();
    incrementBonePile();
  }
}

void dogTookEnemyHit(){
  bool waswithbone = isDogWithBonne();
  
  cDog.LockView(DOGTOOKHIT, eStopMoving);
  if(waswithbone){
    SpawnBone(cDog.x+20, cDog.y+20);
  }
  cDog.TweenY(0.6, 284, eEaseInElasticTween, eBlockTween);
  cDog.UnlockView();
  cDog.ChangeView(DOGWALK1);
  cDog.SetIdleView(DOGIDDLE1, 1);
  KeyboardMovement.SetIdleView(DOGIDDLE1, 1);   
}

void testDogBoneCollision(){
  Character * abone = whichBoneCollidesDog();
  if(abone==null){
    return;  
  }
  
  if(cDog.View == DOGTOOKHIT || cDog.View == DOGWALK2 || cDog.View == DOGIDDLE2){
    //a hitted dog, or a dog that already has a bone, can't collect a new bone
    return;
  }
  
  dogGainsBone();
  TrashBone(abone);
}

void splashArmsLegs(Character * enemy){
  int ox = enemy.x-30;
  int oy = enemy.y-70;
  float timeTw = 0.6;
  
  gLegs1.X = ox;
  gLegs2.X = ox;
  gArms1.X = ox;
  gArms2.X = ox;
  gLegs1.Y = oy;
  gLegs2.Y = oy;
  gArms1.Y = oy;
  gArms2.Y = oy;
  
  if(isCharEnemy1(enemy)){
    gLegs1.BackgroundGraphic = 49;
    gLegs2.BackgroundGraphic = 49;
    gArms1.BackgroundGraphic = 57;
    gArms2.BackgroundGraphic = 57;
    gLegs1.LockView(ENEMY1LEGS);
    gLegs2.LockView(ENEMY1LEGS);
    gArms1.LockView(ENEMY1ARMS);
    gArms2.LockView(ENEMY1ARMS);
    gLegs1.Animate(ENEMY1LEGS, 1, eRepeat, eNoBlock, eForwards);
    gLegs2.Animate(ENEMY1LEGS, 1, eRepeat, eNoBlock, eForwards);
    gArms1.Animate(ENEMY1ARMS, 1, eRepeat, eNoBlock, eForwards);
    gArms2.Animate(ENEMY1ARMS, 1, eRepeat, eNoBlock, eForwards);
  } else if(isCharEnemy1(enemy)){
    gLegs1.BackgroundGraphic = 87;
    gLegs2.BackgroundGraphic = 87;
    gArms1.BackgroundGraphic = 95;
    gArms2.BackgroundGraphic = 95;
    gLegs1.LockView(ENEMY2LEGS);
    gLegs2.LockView(ENEMY2LEGS);
    gArms1.LockView(ENEMY2ARMS);
    gArms2.LockView(ENEMY2ARMS);
    gLegs1.Animate(ENEMY2LEGS, 1, eRepeat, eNoBlock, eForwards);
    gLegs2.Animate(ENEMY2LEGS, 1, eRepeat, eNoBlock, eForwards);
    gArms1.Animate(ENEMY2ARMS, 1, eRepeat, eNoBlock, eForwards);
    gArms2.Animate(ENEMY2ARMS, 1, eRepeat, eNoBlock, eForwards);
  }
  
  gLegs1.Visible = true;
  gLegs2.Visible = true;
  gArms1.Visible = true;
  gArms2.Visible = true;
  
  gLegs1.TweenPosition(timeTw, Room.Width + Random(100), Room.Height + Random(100), eEaseInSineTween, eNoBlockTween);
  gLegs2.TweenPosition(timeTw, 0 -20 - Random(100), Room.Height + Random(100), eEaseInSineTween, eNoBlockTween);
  gArms1.TweenPosition(timeTw, Room.Width + Random(100), Room.Height + Random(100), eEaseInSineTween, eNoBlockTween);
  gArms2.TweenPosition(timeTw, -20- Random(100), Room.Height + Random(100), eEaseInSineTween, eNoBlockTween);
  t_killMember = Timer.StartRT(timeTw, eOnce);
}


void ChompEnemy(Character * enemy){
  if(cDog.NormalView == DOGWALK2){
    return;  
  }
  
  int chomp_delay = 2;
  int x_off = 18 ;
  int y_off =47 ;
  
  if(isCharEnemy1(enemy)){
    enemy.LockView(ENEMY1HIT, eStopMoving);  
  } else if(isCharEnemy2(enemy)){
    enemy.LockView(ENEMY2HIT, eStopMoving);
  }
  
  gBlood.SetPosition(cDog.x - x_off, cDog.y - y_off);
  
  gBlood.Visible = true;
  gBlood.BackgroundGraphic = 66;
  gBlood.LockView(VIEWBLOOD);
  gBlood.Animate(0, 1, eOnce, eNoBlock, eForwards);
  
  gFakeOverlay.BackgroundGraphic = 1;
  gFakeOverlay.SetPosition(cDog.x - x_off, cDog.y - y_off);
  gFakeOverlay.Visible = true;
  Wait(chomp_delay);
  
  gFakeOverlay.BackgroundGraphic = 2;
  Wait(chomp_delay);  

  gFakeOverlay.BackgroundGraphic = 3;
  Wait(chomp_delay);
  
  gFakeOverlay.BackgroundGraphic = 4;
  Wait(chomp_delay);
  
  gBlood.Visible = false;
  gFakeOverlay.Visible = false;
  
  splashArmsLegs(enemy);
  //enemy.UnlockView();
  
  dogGainsBone();
  
  enemy.ChangeRoom(TRASH);  
}

void DoChompOrHit(Character * enemy){
  if(isDogWithBonne()){
    dogTookEnemyHit(); 
    return;   
  }
  
  if((cDog.Loop == 1 && (cDog.Moving == false && !KeyboardMovement.Moving() )) &&
     (enemy.DestinationX == destination_left && enemy.Moving)){
  // dog is stopped looking left &
  // enemy is going left 
  
    dogTookEnemyHit(); 
    return;
    
  } else if((cDog.Loop != 1 && (cDog.Moving == false && !KeyboardMovement.Moving() )) &&
     (enemy.DestinationX == destination_right && enemy.Moving)){
  // dog is stopped looking right &
  // enemy is going right 
  
    dogTookEnemyHit(); 
    return;
  } else if((cDog.Loop == 1 && (cDog.Moving == false || KeyboardMovement.Moving() ))){
  
    ChompEnemy(enemy); 
    return;
  } else if((cDog.Loop != 1 && (cDog.Moving == false || KeyboardMovement.Moving() ))){
  
    ChompEnemy(enemy); 
    return;
  }
}

void dealWithEnemy1(Character * enemy1){
  if(enemy1.Room != player.Room){
    return;  
  }  
  
   if(enemy1.DestinationX == destination_left && enemy1.Moving){
    
  } else if(enemy1.DestinationX == destination_right && enemy1.Moving){
    
  } else if(enemy1.x == destination_left && enemy1.View != ENEMY1HIT){
    enemy1.AddWaypoint(destination_right, enemy1.y);
  } else if(enemy1.x == destination_right && enemy1.View != ENEMY1HIT) {
    enemy1.AddWaypoint(destination_left , enemy1.y);    
  }
  
  if(enemy1.IsCollidingWithChar(cDog)){
    DoChompOrHit(enemy1);
  }
}

// enemy walks around and occasionally pauses to throw letters 
void dealWithEnemy2(Character * enemy2){
  if(enemy2.Room != player.Room){
    return;  
  }
  
  
  if(enemy2.View == ENEMY2THROW){
    if(enemy2.Frame == 2){
      if(!enemy2_didthrow[enemy2.ID]){
        if( enemy2.Loop == 2){
         ThrowLetter(enemy2.x, enemy2.y, eDirectionRight);
        } else {
         ThrowLetter(enemy2.x, enemy2.y, eDirectionLeft);          
        }
      }
      
      enemy2_didthrow[enemy2.ID] = true;
    } else {
      enemy2_didthrow[enemy2.ID] = false;
    }
  }
  
  
  if(t_enemy2_whenToStartThrow[enemy2.ID] != null && t_enemy2_whenToStartThrow[enemy2.ID].EvtExpired){
    t_enemy2_whenToStartThrow[enemy2.ID] = null;
    
    t_enemy2[enemy2.ID] = Timer.StartRT(1.9, eOnce);
  }
  
  
  if(t_enemy2[enemy2.ID] != null && t_enemy2[enemy2.ID].EvtExpired){
    t_enemy2[enemy2.ID] = null;
    if(enemy2.View == ENEMY2THROW){
      enemy2.UnlockView();
    }
    
    enemy2.PlaceOnWalkableArea();
    if(enemy2.Loop == 2){
      //looking right
      enemy2.AddWaypoint(destination_right, enemy2.y);      
    } else {
      //looking left maybe
      enemy2.AddWaypoint(destination_left , enemy2.y);    
    }
    
  }  
  
  if(t_enemy2[enemy2.ID] != null && enemy2.View != ENEMY2THROW){
    enemy2.LockView(ENEMY2THROW, eStopMoving);
    enemy2.Animate(enemy2.Loop, 4, eRepeat, eNoBlock);
  } else if(t_enemy2[enemy2.ID] != null && enemy2.View == ENEMY2THROW) {
    
  } else {
    if(t_enemy2_whenToStartThrow[enemy2.ID] == null ){
      t_enemy2_whenToStartThrow[enemy2.ID] = Timer.StartRT(0.5+IntToFloat(Random(8))*0.1, eOnce);
    }  
    
    
    if(enemy2.DestinationX == destination_left && enemy2.Moving){
      
    } else if(enemy2.DestinationX == destination_right && enemy2.Moving){
      
    } else if(enemy2.x == destination_left && enemy2.View != ENEMY1HIT){
      enemy2.AddWaypoint(destination_right, enemy2.y);
    } else if(enemy2.x == destination_right && enemy2.View != ENEMY1HIT) {
      enemy2.AddWaypoint(destination_left , enemy2.y);    
    }
    
  }
  
  
  if(enemy2.IsCollidingWithChar(cDog)){
    DoChompOrHit(enemy2);
  }
}

void checkBonePileRepExe(){
  if(cBonePile.IsCollidingWithChar(cDog)){
    dogHitBonePile();
  } 
}


void init_enemy1(Character * enemy1){
  enemy1.AddWaypoint(destination_left, enemy1.y);  
}

void init_enemy2(Character * enemy2){
  enemy2.AddWaypoint(destination_left, enemy2.y);  
}

void repeatedly_execute(){
  Character * aLetter = whichLetterCollided();
  if(aLetter!=null){
    dogTookEnemyHit();  
  }
  
  testDogBoneCollision();
  
  if(t_killMember!=null && t_killMember.EvtExpired){
    gLegs1.UnlockView();
    gLegs2.UnlockView();
    gArms1.UnlockView();
    gArms2.UnlockView();
    
  }  
}

void resetTimers(){
  int i=0;
  
  while(i<APROXCHAR){
    t_enemy2[i]=null;  //time throwing
    t_enemy2_whenToStartThrow[i]=null;  //this number is only big enough to not crash
    enemy2_didthrow[i]=false;
    i++;  
  }


}

void on_event (EventType event, int data){
  if(event == eEventLeaveRoom){
    resetBonePile();  
    resetTimers();
  }
}