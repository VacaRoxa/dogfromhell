// new module script
int bonePileCount;
Timer * t_killMember;

int destination_left;
int destination_right;

function game_start(){
  destination_left = 24 ;
  destination_right = Room.Width - 40;
}

bool isDogWithBonne(){
  return cDog.View == DOGIDDLE2 || cDog.View == DOGWALK2 ; 
}

bool isCharEnemy1(Character * enemy){
  return enemy.ID == cEnemy1_0.ID ||   
         enemy.ID == cEnemy1_1.ID ||  
         enemy.ID == cEnemy1_2.ID ||  
         enemy.ID == cEnemy1_3.ID ;
}

bool isCharEnemy2(Character * enemy){
  return enemy.ID == cEnemy2_0.ID ||   
         enemy.ID == cEnemy2_1.ID ||  
         enemy.ID == cEnemy2_2.ID ||  
         enemy.ID == cEnemy2_3.ID ;
}

void dogLooseBone(){
  if(isDogWithBonne()){
    cDog.ChangeView(DOGWALK1);
    cDog.SetIdleView(DOGIDDLE1, 1);
    KeyboardMovement.SetIdleView(DOGIDDLE1, 1);   
  }
}

void updateBonePileGraphic(){
  if(bonePileCount == 0){
    cBonePile.ChangeView(BONEPILE0);
  } else if(bonePileCount == 1){
    cBonePile.ChangeView(BONEPILE1);
  } else if(bonePileCount == 2){
    cBonePile.ChangeView(BONEPILE2);
  } else if(bonePileCount == 3){
    cBonePile.ChangeView(BONEPILE3);
  } 
}

void resetBonePile(){
  bonePileCount = 0;
  updateBonePileGraphic();
} 

int incrementBonePile(){
  bonePileCount++;
  updateBonePileGraphic();
}

void dogHitBonePile(){
  if(isDogWithBonne()){
    dogLooseBone();
    incrementBonePile();
  }
}

void dogTookEnemyHit(){
  cDog.LockView(DOGTOOKHIT, eStopMoving);
  cDog.TweenY(0.6, 284, eEaseInElasticTween, eBlockTween);
  cDog.UnlockView();
  cDog.ChangeView(DOGWALK1);
  cDog.SetIdleView(DOGIDDLE1, 1);
  KeyboardMovement.SetIdleView(DOGIDDLE1, 1);   
}


void splashArmsLegs(Character * enemy){
  int ox = enemy.x-30;
  int oy = enemy.y-70;
  float timeTw = 0.6;
  
  gLegs1.X = ox;
  gLegs2.X = ox;
  gArms1.X = ox;
  gArms2.X = ox;
  gLegs1.Y = oy;
  gLegs2.Y = oy;
  gArms1.Y = oy;
  gArms2.Y = oy;
  
  if(isCharEnemy1(enemy)){
    gLegs1.BackgroundGraphic = 49;
    gLegs2.BackgroundGraphic = 49;
    gArms1.BackgroundGraphic = 57;
    gArms2.BackgroundGraphic = 57;
    gLegs1.LockView(ENEMY1LEGS);
    gLegs2.LockView(ENEMY1LEGS);
    gArms1.LockView(ENEMY1ARMS);
    gArms2.LockView(ENEMY1ARMS);
    gLegs1.Animate(ENEMY1LEGS, 1, eRepeat, eNoBlock, eForwards);
    gLegs2.Animate(ENEMY1LEGS, 1, eRepeat, eNoBlock, eForwards);
    gArms1.Animate(ENEMY1ARMS, 1, eRepeat, eNoBlock, eForwards);
    gArms2.Animate(ENEMY1ARMS, 1, eRepeat, eNoBlock, eForwards);
  } else if(isCharEnemy1(enemy)){
    gLegs1.BackgroundGraphic = 87;
    gLegs2.BackgroundGraphic = 87;
    gArms1.BackgroundGraphic = 95;
    gArms2.BackgroundGraphic = 95;
    gLegs1.LockView(ENEMY2LEGS);
    gLegs2.LockView(ENEMY2LEGS);
    gArms1.LockView(ENEMY2ARMS);
    gArms2.LockView(ENEMY2ARMS);
    gLegs1.Animate(ENEMY2LEGS, 1, eRepeat, eNoBlock, eForwards);
    gLegs2.Animate(ENEMY2LEGS, 1, eRepeat, eNoBlock, eForwards);
    gArms1.Animate(ENEMY2ARMS, 1, eRepeat, eNoBlock, eForwards);
    gArms2.Animate(ENEMY2ARMS, 1, eRepeat, eNoBlock, eForwards);
  }
  
  gLegs1.Visible = true;
  gLegs2.Visible = true;
  gArms1.Visible = true;
  gArms2.Visible = true;
  
  gLegs1.TweenPosition(timeTw, Room.Width + Random(100), Room.Height + Random(100), eEaseInSineTween, eNoBlockTween);
  gLegs2.TweenPosition(timeTw, 0 -20 - Random(100), Room.Height + Random(100), eEaseInSineTween, eNoBlockTween);
  gArms1.TweenPosition(timeTw, Room.Width + Random(100), Room.Height + Random(100), eEaseInSineTween, eNoBlockTween);
  gArms2.TweenPosition(timeTw, -20- Random(100), Room.Height + Random(100), eEaseInSineTween, eNoBlockTween);
  t_killMember = Timer.StartRT(timeTw, eOnce);
}


void ChompEnemy(Character * enemy){
  if(cDog.NormalView == DOGWALK2){
    return;  
  }
  
  int chomp_delay = 2;
  int x_off = 18 ;
  int y_off =47 ;
  
  if(isCharEnemy1(enemy)){
    enemy.LockView(ENEMY1HIT, eStopMoving);  
  } else if(isCharEnemy2(enemy)){
    enemy.LockView(ENEMY2HIT, eStopMoving);
  }
  
  
  gBlood.SetPosition(cDog.x - x_off, cDog.y - y_off);
  
  gBlood.Visible = true;
  gBlood.BackgroundGraphic = 66;
  gBlood.LockView(VIEWBLOOD);
  gBlood.Animate(0, 1, eOnce, eNoBlock, eForwards);
  
  gFakeOverlay.BackgroundGraphic = 1;
  gFakeOverlay.SetPosition(cDog.x - x_off, cDog.y - y_off);
  gFakeOverlay.Visible = true;
  Wait(chomp_delay);
  
  gFakeOverlay.BackgroundGraphic = 2;
  Wait(chomp_delay);  

  gFakeOverlay.BackgroundGraphic = 3;
  Wait(chomp_delay);
  
  gFakeOverlay.BackgroundGraphic = 4;
  Wait(chomp_delay);
  
  gBlood.Visible = false;
  gFakeOverlay.Visible = false;
  
  splashArmsLegs(enemy);
  //enemy.UnlockView();
  
  cDog.ChangeView(DOGWALK2);
  cDog.SetIdleView(DOGIDDLE2, 1);
  KeyboardMovement.SetIdleView(DOGIDDLE2, 1);
  
  enemy.ChangeRoom(TRASH);  
}

void DoChompOrHit(Character * enemy){
  
  if((cDog.Loop == 1 && (cDog.Moving == false || !KeyboardMovement.Moving() )) &&
     (enemy.DestinationX == destination_left && enemy.Moving)){
  // dog is stopped looking left &
  // enemy is going left 
  
    dogTookEnemyHit(); 
    
  } else if((cDog.Loop != 1 && (cDog.Moving == false || !KeyboardMovement.Moving() )) &&
     (enemy.DestinationX == destination_right && enemy.Moving)){
  // dog is stopped looking right &
  // enemy is going right 
  
    dogTookEnemyHit(); 
  } else if((cDog.Loop == 1 && (cDog.Moving == false || KeyboardMovement.Moving() ))){
  
    ChompEnemy(enemy); 
  } else if((cDog.Loop != 1 && (cDog.Moving == false || KeyboardMovement.Moving() ))){
  
    ChompEnemy(enemy); 
  }
}

void dealWithEnemy1(Character * enemy1){
   if(enemy1.DestinationX == destination_left && enemy1.Moving){
    
  } else if(enemy1.DestinationX == destination_right && enemy1.Moving){
    
  } else if(enemy1.x == destination_left && enemy1.View != ENEMY1HIT){
    enemy1.AddWaypoint(destination_right, enemy1.y);
  } else if(enemy1.x == destination_right && enemy1.View != ENEMY1HIT) {
    enemy1.AddWaypoint(destination_left , enemy1.y);    
  }
  
  if(enemy1.IsCollidingWithChar(cDog)){
    DoChompOrHit(enemy1);
  }
}

void checkBonePileRepExe(){
  if(cBonePile.IsCollidingWithChar(cDog)){
    dogHitBonePile();
  } 
}


void init_enemy1(Character * enemy1){
  enemy1.AddWaypoint(destination_left, enemy1.y);  
}

void repeatedly_execute(){
  if(t_killMember!=null && t_killMember.EvtExpired){
    gLegs1.UnlockView();
    gLegs2.UnlockView();
    gArms1.UnlockView();
    gArms2.UnlockView();
    
  }  
}